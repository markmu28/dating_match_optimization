# 相亲活动分组优化工具 v1.2

一个用于解析中文自然语言偏好并生成最优分组方案的Python工具。

## 功能特点

- **双模式解析**：支持Ranking ID模式（默认）和中文偏好描述解析
- **两轮分组系统**：第一轮基础分组 + 第二轮避重复优化分组
- **灵活分组约束**：支持2男2女分组模式和1男1女配对模式  
- **特权嘉宾功能**：🌟 支持指定特权嘉宾，保证与至少一个喜欢的人同组
- **智能惩罚机制**：第二轮自动避免第一轮单向喜欢重复，保持双向喜欢优势
- **双重求解策略**：启发式算法（默认）+ ILP最优解回退
- **多格式输出**：JSON、CSV、Excel结果导出，自动区分轮次
- **可复现结果**：支持随机种子设置

## 系统测试结果

✅ **测试成功完成！**

使用24名嘉宾（12男12女）的偏好数据测试：

- **解析结果**：成功从中文描述中提取51条有向偏好边
- **分组方案**：6组，每组4人（2男2女）
- **总得分**：14.0分
- **命中统计**：12条单向喜欢，1对互相喜欢
- **平均每组得分**：2.3分

### 分组示例
```
第1组: ['M12', 'M3', 'F4', 'F8'] (得分: 4.0)
  - 单向喜欢: M3→F4, M12→F4  
  - 互相喜欢: F4↔F8

第6组: ['M7', 'M2', 'F1', 'F5'] (得分: 3.0)
  - 单向喜欢: M2→F1, M2→F5, M7→F5
```

## 项目结构

```
.
├── src/
│   ├── parser_cn.py      # 中文偏好解析器
│   ├── graph.py          # 图建模和评分系统  
│   ├── solver_ilp.py     # ILP最优求解器
│   ├── solver_heur.py    # 启发式求解器
│   └── io_excel.py       # Excel/CSV/JSON IO处理
├── cli.py                # 命令行工具入口
├── requirements.txt      # 依赖库列表
├── 嘉宾偏好.xlsx         # 示例数据文件
├── outputs/              # 结果输出目录
├── interactive_gui.py    # 图形界面程序
├── 相亲分组工具.bat      # Windows可执行文件
├── 相亲分组工具.command  # macOS/Linux可执行文件
└── final_test.py         # 测试脚本
```

## 快速开始

### 🖱️ 图形界面（推荐）

**双击运行可执行文件：**
- **Windows用户**：双击 `相亲分组工具.bat`
- **macOS/Linux用户**：双击 `相亲分组工具.command`

🎯 **功能特点：**
- 图形化文件选择，无需记忆命令
- 实时显示详细运行日志
- 一键配置所有参数
- **自动安装依赖**：首次运行自动检测并安装所需库
- 结果自动保存到`outputs/`目录
- 跨平台支持Windows/macOS/Linux

### 📋 界面说明
- **左侧控制面板**：文件选择、参数配置、运行控制
- **右侧日志面板**：实时显示verbose输出，黑底绿字终端风格
- **停止按钮**：可随时中止运行
- **清空日志**：清除历史输出

### 🎛️ 配置选项
- **每组人数**：默认4人，支持任意组大小
- **第几轮**：选择1或2，第2轮需要第一轮结果文件
- **配对模式**：勾选后生成1v1配对而非多人分组
- **特权嘉宾**：🌟 输入嘉宾ID（如M1,F3），保证与喜欢的人同组
- **求解器**：auto（推荐）、heuristic、ilp
- **数据模式**：ranking（ID排名）、text（中文描述）
- **导出Excel**：生成Excel格式结果文件

### 🔧 首次运行说明
**完全免安装！** 双击可执行文件后会自动：
1. 检查Python环境（需要预装Python 3.6+）
2. 检测所需依赖库（pandas、openpyxl等）
3. 如缺少依赖则自动安装（可能需要几分钟）
4. 安装完成后自动启动图形界面

**如果自动安装失败**，程序会提供详细的手动安装指南。

### 💻 命令行使用

#### 安装依赖
```bash
pip install -r requirements.txt
```

#### 基本使用
```bash
# 使用默认设置处理Excel文件（推荐ranking模式）
python cli.py --input 嘉宾偏好.xlsx

# 导出Excel结果
python cli.py --input 嘉宾偏好.xlsx --export-xlsx

# 仅解析偏好（不求解）
python cli.py --input 嘉宾偏好.xlsx --dry-run-parse

# 明确使用启发式算法
python cli.py --input 嘉宾偏好.xlsx --solver heuristic --seed 42

# 1v1配对模式（12对而非6组）
python cli.py --input 嘉宾偏好.xlsx --pairing-mode

# 🌟 指定特权嘉宾（保证与喜欢的人同组）
python cli.py --input 嘉宾偏好.xlsx --privileged-guests M1,F3,M5 --export-xlsx

# 使用text模式解析中文偏好描述
python cli.py --input 数据.xlsx --mode text

# 尝试ILP求解器（可能不稳定）
python cli.py --input 嘉宾偏好.xlsx --solver ilp
```

### 完整CLI选项参考

#### 必需参数
- `--input, -i`: 输入Excel文件路径（必填）

#### 输入选项
- `--sheet`: Excel sheet名称（默认: 偏好）
- `--mode`: 输入数据模式
  - `ranking`: 排名ID模式（默认）
  - `text`: 中文描述解析

#### Ranking模式权重设置
- `--first-preference-weight`: 第一偏好权重（默认: 2.0）
- `--second-preference-weight`: 第二偏好权重（默认: 1.0）

#### 分组约束选项
- `--two-by-two`: 是否强制每组2男2女（默认: true）
- `--pairing-mode`: 1男1女配对模式，生成12对1v1配对而不是6组2v2分组
- `--privileged-guests`: 🌟 特权嘉宾列表，用逗号分隔（例如：M1,F3,M5）
  - 特权嘉宾保证分到至少一个自己喜欢的嘉宾同组
  - 支持任意数量的特权嘉宾
  - 实时显示特权约束满足情况和满足率

#### 第二轮分组选项
- `--round-two`: 第二轮分组模式，基于第一轮结果进行重新分组
- `--first-round-file`: 第一轮结果JSON文件路径（用于第二轮分组）
- `--penalty-weight`: 第一轮单向喜欢关系的惩罚权重（默认: -1.0）

#### 评分选项
- `--mutual-weight`: 互相喜欢的总权重（默认: 2.0）

#### 求解器选项
- `--solver`: 求解器选择（默认: auto）
  - `auto`: 自动选择
  - `ilp`: 整数线性规划
  - `heuristic`: 启发式算法

#### 启发式算法参数
- `--seed`: 随机种子（用于可重现结果）
- `--max-iter`: 启发式算法最大迭代次数（默认: 10000）
- `--num-restarts`: 启发式算法重启次数（默认: 5）
- `--heur-algorithm`: 启发式算法类型（默认: simulated_annealing）
  - `hill_climbing`: 爬山算法
  - `simulated_annealing`: 模拟退火

#### 输出选项
- `--export-xlsx`: 导出Excel格式结果
- `--output-dir`: 输出目录（默认: outputs）

#### 调试选项
- `--dry-run-parse`: 仅解析偏好数据，不进行求解
- `--verbose`: 详细输出模式

#### ILP选项
- `--ilp-time-limit`: ILP求解时间限制（秒，默认: 300）

### 使用示例

#### 基础使用
```bash
# 第一轮分组：默认ranking模式，2v2分组，导出Excel
python cli.py --input 嘉宾偏好.xlsx --export-xlsx --verbose

# 双人配对模式（12对1v1），自定义权重
python cli.py --input 数据.xlsx --pairing-mode --first-preference-weight 3.0 --second-preference-weight 1.5 --export-xlsx

# 中文偏好解析模式
python cli.py --input 数据.xlsx --mode text --export-xlsx

# 启发式算法，指定随机种子，增加重启次数
python cli.py --input 数据.xlsx --solver heuristic --seed 42 --num-restarts 10 --max-iter 20000

# 取消性别约束，使用爬山算法
python cli.py --input 数据.xlsx --two-by-two false --heur-algorithm hill_climbing

# 仅解析测试，不求解
python cli.py --input 数据.xlsx --dry-run-parse --verbose
```

#### 🌟 特权嘉宾功能使用
```bash
# 指定单个特权嘉宾
python cli.py --input 嘉宾偏好.xlsx --privileged-guests M1 --export-xlsx

# 指定多个特权嘉宾
python cli.py --input 嘉宾偏好.xlsx --privileged-guests M1,F3,M5,F8 --export-xlsx

# 特权嘉宾 + 配对模式
python cli.py --input 嘉宾偏好.xlsx --privileged-guests M1,F3 --pairing-mode --export-xlsx

# 特权嘉宾 + 第二轮分组
python cli.py --round-two --first-round-file "outputs/安排结果_第一轮.json" --input 嘉宾偏好.xlsx --privileged-guests M1,F2 --export-xlsx
```

#### 第二轮分组使用
```bash
# 基于第一轮结果进行第二轮分组
python cli.py --round-two --first-round-file "outputs/安排结果_第一轮.json" --input 嘉宾偏好.xlsx --export-xlsx

# 自定义第一轮单向喜欢的惩罚权重
python cli.py --round-two --first-round-file "outputs/安排结果_第一轮.json" --input 嘉宾偏好.xlsx --penalty-weight -2.0

# 第二轮详细输出模式
python cli.py --round-two --first-round-file "outputs/安排结果_第一轮.json" --input 嘉宾偏好.xlsx --verbose --export-xlsx
```

## Edge Case边界测试

本工具通过了**27种极端场景**的全面测试，验证了系统的鲁棒性和智能处理能力：

### 📊 ID格式异常处理
- ✅ **全角字符**：Ｆ２、Ｍ１等格式，产生格式错误警告但不中断处理
- ✅ **空格混乱**：" F 2 "等带空格格式，自动识别并警告
- ✅ **Unicode问题**：不可见字符干扰，稳定处理产生警告

### 📈 极端数据分布处理  
- ✅ **超级明星效应**：所有人选同一对象，算法智能避免竞争冲突
- ✅ **孤立岛屿模式**：形成独立小圈子，达到100%互相喜欢命中率
- ✅ **单向长链结构**：A→B→C链式偏好，达到75%互相喜欢命中率
- ✅ **完全循环偏好**：三角循环偏好关系，达到100%命中率
- ✅ **偏好缺失模式**：只有单向偏好数据，达到100%命中率
- ✅ **性别不平衡偏好**：10男喜欢2女的极端情况，仍能优化分组
- ✅ **集中vs分散模式**：混合偏好模式，达到56.2%单向命中率
- ✅ **空数据处理**：完全无数据时合理报错退出
- ✅ **错误标题格式**：按位置匹配列名，产生警告但继续处理

### 🔗 图结构特殊性处理
- ✅ **完全双向图**：密集连接图，达到100%互相喜欢命中率
- ✅ **星形结构**：中心节点连接模式，达到33.3%单向命中率
- ✅ **链状断裂**：断点链式结构，达到75%单向命中率
- ✅ **多个孤立节点**：无连接情况，0得分但正常分组

### ⚖️ 权重分布极端化处理
- ✅ **全是第一偏好**：高权重单一偏好，达到100%互相命中率
- ✅ **全是第二偏好**：低权重单一偏好，达到100%互相命中率（已修复bug）
- ✅ **权重分布测试**：混合权重模式，达到50%互相命中率

### 📏 数据量级边界处理
- ✅ **最小可行数据**：2男2女最小场景，达到100%互相命中率  
- ⚠️ **奇数性别**：3男2女等不平衡场景，**合理求解失败**（无法维持1:1比例）
- ✅ **大规模稀疏**：20人仅2条边，成功处理稀疏数据

### 🎯 偏好冲突模式处理
- ✅ **互斥选择**：A→B→C→A冲突模式，达到66.7%单向命中率
- ⚠️ **单向拒绝**：A选B但B不选A，**合理求解失败**（性别不平衡导致）
- ✅ **传递矛盾**：复杂传递关系，达到66.7%互相命中率

### 👥 极端性别比例处理
- ⚠️ **严重性别失衡**：10男1女极端比例，**合理求解失败**（无法平衡分组）
- ✅ **完全同性数据**：3男选3男，检测到性别不匹配并警告

### 🔍 关键测试发现
1. **智能错误恢复**：27种格式异常都不会导致系统崩溃，提供详细警告信息
2. **约束检测准确**：性别比例约束导致的无解情况被正确识别并报告
3. **算法高鲁棒性**：即使在极端数据分布下仍能找到较优解决方案
4. **边界处理完善**：从最小2人到大规模稀疏数据都能正常处理
5. **Bug主动发现**：测试过程中发现并修复了"全是第二偏好"的变量未定义问题

### 📋 测试覆盖率总结
- **成功处理**：24/27种场景（89%）
- **合理失败**：3/27种场景（11%，因约束冲突导致的预期失败）
- **异常处理**：100%覆盖，无系统崩溃
- **数据质量反馈**：100%提供详细警告信息

## 输入数据格式

### Ranking模式（默认）
Excel文件需包含4列：

| 嘉宾类型 | 编号 | 对象1ID | 对象2ID |
|---------|------|---------|---------|
| 男 | 1 | F3 | F6 |
| 女 | 1 | M4 | M2 |

- 对象1ID：第一偏好的异性嘉宾ID（如F3表示3号女嘉宾）
- 对象2ID：第二偏好的异性嘉宾ID（如M4表示4号男嘉宾）
- 系统会自动为第一偏好分配更高权重

### Text模式
Excel文件需包含3列：

| 嘉宾类型 | 编号 | 偏好描述 |
|---------|------|----------|
| 男 | 1 | 1号男嘉宾喜欢3号、6号和9号女嘉宾。|
| 女 | 1 | 1号女嘉宾喜欢4号和2号男嘉宾。|

#### 支持的中文表达
- 偏好动词：喜欢、偏好、中意、最想认识、希望同组、有好感等
- 连接词：和、或、、（顿号）、，（逗号）、以及、还有、与
- 自动性别推断：从"男嘉宾"/"女嘉宾"推断目标性别


## 完整工作流程示例

### 典型的两轮分组流程

```bash
# 步骤1：第一轮分组（6组2v2模式）
python cli.py --input 嘉宾偏好_第一轮.xlsx --export-xlsx --verbose
# 输出：outputs/安排结果_第一轮.json, .csv, .xlsx

# 步骤2：基于第一轮结果进行第二轮分组
python cli.py --round-two --first-round-file "outputs/安排结果_第一轮.json" --input 嘉宾偏好_第二轮.xlsx --export-xlsx --verbose
# 输出：outputs/安排结果_第二轮.json, .csv, .xlsx

# 步骤3：对比两轮结果
# 查看第一轮：outputs/安排结果_第一轮.xlsx
# 查看第二轮：outputs/安排结果_第二轮.xlsx
```

### 双人配对模式流程

```bash
# 双人配对模式（12对1v1模式）
python cli.py --input 嘉宾偏好_第三轮.xlsx --pairing-mode --export-xlsx --verbose
# 输出：outputs/安排结果_双人配对.json, .csv, .xlsx

# 查看配对结果
# 查看配对：outputs/安排结果_双人配对.xlsx
```

### 三种分组模式对比

| 模式 | 输出格式 | 适用场景 | 文件后缀 |
|------|---------|----------|----------|
| **第一轮分组** | 6组，每组4人（2男2女） | 初次相亲活动分组 | `_第一轮` |
| **第二轮分组** | 6组，每组4人（2男2女） | 避免第一轮重复的二次分组 | `_第二轮` |
| **双人配对** | 12对，每对2人（1男1女） | 一对一深度交流场景 | `_双人配对` |

### 双人配对模式的原理

1. **一对一深度交流**：每位嘉宾只配对一位异性，便于深入了解
2. **最大化个人偏好**：优先匹配第一偏好和第二偏好关系
3. **性别平衡**：确保每对都是1男1女的组合
4. **适用场景**：速配活动、深度交谈环节、个性化匹配

### 第二轮分组的原理

1. **第一轮单向喜欢惩罚**：第一轮中A单向喜欢B（但B不回应），第二轮会降低A-B同组的优先级
2. **保持双向喜欢优势**：第一轮中的双向喜欢关系在第二轮仍可正常匹配
3. **完全重新分组**：第二轮完全打散重新分配，确保不同的社交体验
4. **目标函数优化**：最大化新的偏好命中 - 第一轮单向喜欢的重复惩罚

### 输出文件说明

#### 第一轮分组输出
- `outputs/安排结果_第一轮.json`：完整的分组结果和统计信息（6组2v2）
- `outputs/安排结果_第一轮.csv`：CSV格式的分组汇总  
- `outputs/安排结果_第一轮.xlsx`：Excel格式（可选，使用`--export-xlsx`）

#### 第二轮分组输出
- `outputs/安排结果_第二轮.json`：第二轮完整结果（避免第一轮单向喜欢重复，6组2v2）
- `outputs/安排结果_第二轮.csv`：第二轮CSV格式汇总
- `outputs/安排结果_第二轮.xlsx`：第二轮Excel格式

#### 双人配对输出
- `outputs/安排结果_双人配对.json`：双人配对完整结果（12对1v1）
- `outputs/安排结果_双人配对.csv`：双人配对CSV格式汇总
- `outputs/安排结果_双人配对.xlsx`：双人配对Excel格式

## 输出结果

## 算法说明

### 评分机制

#### 第一轮分组
- 单向喜欢：1分（或自定义权重）
- 互相喜欢：2分（可通过`--mutual-weight`调整）
- 总得分 = Σ单向喜欢得分 + Σ互相喜欢得分

#### 第二轮分组
- 单向喜欢：1分（或自定义权重）
- 互相喜欢：2分（可通过`--mutual-weight`调整）
- **第一轮单向喜欢惩罚**：-1分（可通过`--penalty-weight`调整）
- 总得分 = Σ单向喜欢得分 + Σ互相喜欢得分 + Σ第一轮惩罚得分

### 求解策略
1. **优先启发式**：使用模拟退火算法（更稳定）
2. **回退ILP**：当启发式失败时，尝试整数线性规划
3. **多次重启**：通过随机重启提高解的质量
4. **第二轮约束**：在目标函数中加入第一轮单向喜欢的负权重

## 验收标准 ✅

- [x] 成功解析中文偏好描述，提取有向边
- [x] 生成6组分组方案（每组4人，2男2女）
- [x] 计算并输出详细的得分统计
- [x] 支持JSON/CSV/Excel多种输出格式
- [x] 解析器对常见中文句式具有鲁棒性
- [x] 启发式算法提供合理的非零得分方案
- [x] 系统测试全部通过

## 故障排除

### ILP求解器问题
如果遇到ILP相关错误（如"Non-constant expressions cannot be multiplied"），建议：

1. **使用启发式算法**：
   ```bash
   python cli.py --input 文件.xlsx --solver heuristic
   ```

2. **让系统自动选择**（默认优先启发式）：
   ```bash
   python cli.py --input 文件.xlsx --solver auto
   ```

3. **启发式算法优势**：
   - 更稳定，不依赖外部求解器
   - 速度快，适合大规模问题
   - 结果质量通常很好

### 依赖安装问题
如果`pip install -r requirements.txt`失败，可逐个安装：
```bash
pip install pandas openpyxl pulp numpy
```

### Python版本兼容性
- 推荐Python 3.6+
- 如遇语法错误，请确保使用Python 3而非Python 2

## 技术亮点

1. **智能中文解析**：正则表达式 + 词典匹配，支持复杂中文语法
2. **双重求解保障**：ILP最优解 + 启发式回退，确保总能产生结果
3. **灵活配置选项**：支持多种约束和参数调整
4. **完善错误处理**：对解析失败给出警告但不终止流程
5. **可复现结果**：支持随机种子，便于调试和验证
6. **自动回退机制**：ILP失败时自动使用启发式算法
7. **改进的性别推断**：修复了多性别文本中的目标性别识别错误

## 最近修复

### v1.2 更新内容 (当前版本)

1. **动态人数支持**：
   - 支持任意数量嘉宾（不再限制24人）
   - 自动检测嘉宾人数并计算最优分组数量
   - 最后一组人数不足时自动调整
   - 新增`--group-size`参数控制每组人数

2. **边界测试完善**：  
   - 通过27种极端场景测试验证系统鲁棒性
   - 修复"全是第二偏好"解析的变量未定义bug
   - 完善异常处理和错误恢复机制
   - 100%覆盖格式异常处理，无系统崩溃

3. **算法优化**：
   - 启发式算法支持动态约束生成
   - ILP求解器支持可变组数和灵活约束
   - 自动处理性别比例不平衡的无解情况

### v1.1 修复内容

1. **修复性别推断逻辑**：
   - 改进了当文本包含多种性别标识时的处理逻辑
   - 优先选择非主体性别作为目标性别
   - 减少了错误的互相喜欢关系识别

2. **增强偏好动词支持**：
   - 添加了"想和...同组认识"等更多表达方式
   - 提高了偏好识别的准确性

3. **优化求解器选择**：
   - 默认优先使用更稳定的启发式算法
   - ILP求解器作为备选方案

### 使用建议

推荐使用启发式算法以获得最稳定的结果：
```bash
python cli.py --input 嘉宾偏好.xlsx --solver heuristic --seed 42
```

## 完整工作流程示例

### 典型的两轮分组流程
### 安装依赖
```bash
pip install -r requirements.txt
```

```bash
# 步骤1：第一轮分组（6组2v2模式）
python3 cli.py --input 嘉宾偏好_第一轮.xlsx --export-xlsx --verbose --privileged-guests M1
# 输出：outputs/安排结果_第一轮.json, .csv, .xlsx

# 步骤2：基于第一轮结果进行第二轮分组
python3 cli.py --round-two --first-round-file "outputs/安排结果_第一轮.json" --input 嘉宾偏好_第二轮.xlsx --export-xlsx --verbose --privileged-guests M1
# 输出：outputs/安排结果_第二轮.json, .csv, .xlsx
```

### 双人配对模式流程

```bash
# 双人配对模式（12对1v1模式）
python3 cli.py --input 嘉宾偏好_第三轮.xlsx --pairing-mode --export-xlsx --verbose --privileged-guests M1
# 输出：outputs/安排结果_双人配对.json, .csv, .xlsx